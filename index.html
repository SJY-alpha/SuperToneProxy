<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Supertone 보이스 라이브러리</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --sidebar-bg: #f8fafc;
            --main-bg: #ffffff;
            --text-primary: #1e293b;
            --text-secondary: #64748b;
            --accent-color: #3b82f6;
            --border-color: #e2e8f0;
        }
        @media (prefers-color-scheme: dark) {
            :root {
                --sidebar-bg: #1e293b;
                --main-bg: #0f172a;
                --text-primary: #f8fafc;
                --text-secondary: #94a3b8;
                --accent-color: #60a5fa;
                --border-color: #334155;
            }
        }
        body { font-family: 'Inter', sans-serif; background-color: var(--main-bg); color: var(--text-primary); }
        .sidebar { background-color: var(--sidebar-bg); }
        .voice-card { background-color: var(--sidebar-bg); border: 1px solid var(--border-color); transition: all 0.2s ease-in-out; }
        .voice-card:hover { transform: translateY(-2px); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .loader { border-top-color: var(--accent-color); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        /* 스크롤바 스타일 */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: var(--sidebar-bg); }
        ::-webkit-scrollbar-thumb { background: #888; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #555; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>
<body class="flex h-screen">

    <!-- Sidebar for Filters -->
    <aside class="sidebar w-64 p-6 flex-shrink-0 overflow-y-auto">
        <h2 class="text-xl font-bold mb-6">검색 필터</h2>
        <div class="space-y-6">
            <!-- Language Filter -->
            <div>
                <h3 class="font-semibold mb-2">언어 (Language)</h3>
                <div class="space-y-2 filter-group" data-filter-key="language">
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="">전체</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="ko">한국어</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="en">영어</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="ja">일본어</button>
                </div>
            </div>
            <!-- Gender Filter -->
            <div>
                <h3 class="font-semibold mb-2">성별 (Gender)</h3>
                <div class="space-y-2 filter-group" data-filter-key="gender">
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="">전체</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="male">남성</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="female">여성</button>
                </div>
            </div>
            <!-- Age Filter -->
            <div>
                <h3 class="font-semibold mb-2">연령대 (Age)</h3>
                <div class="space-y-2 filter-group" data-filter-key="age">
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="">전체</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="child">어린이</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="young-adult">청년</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="middle-aged">중년</button>
                    <button class="filter-btn w-full text-left p-2 rounded-md" data-value="elder">노년</button>
                </div>
            </div>
             <!-- Name Search -->
             <div>
                <h3 class="font-semibold mb-2">이름으로 검색</h3>
                <input type="text" id="name-search" placeholder="이름 입력..." class="w-full p-2 border rounded-md bg-transparent border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col p-6">
        <header class="mb-4">
            <h1 class="text-3xl font-bold">Supertone 보이스 라이브러리</h1>
            <p id="status-message" class="text-secondary h-6"></p>
        </header>
        
        <div id="voice-grid" class="flex-1 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-4 overflow-y-auto pr-2">
            <!-- Voice cards will be dynamically inserted here -->
        </div>

        <div id="empty-state" class="hidden flex-1 items-center justify-center">
            <p class="text-secondary text-lg">조건에 맞는 목소리가 없습니다.</p>
        </div>
         <div id="loading-state" class="flex flex-1 items-center justify-center">
            <div class="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-24 w-24"></div>
        </div>


        <!-- TTS Control Panel -->
        <footer class="mt-4 p-4 border-t border-gray-200 dark:border-gray-700 bg-white dark:bg-gray-800 rounded-lg shadow-md flex items-center gap-4">
            <textarea id="text-input" rows="1" class="flex-grow p-2 border rounded-md bg-transparent border-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="텍스트를 입력하여 선택한 목소리로 생성해보세요..."></textarea>
            <button id="generate-btn" class="bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 disabled:bg-gray-400 transition flex items-center" disabled>
                <svg id="generate-icon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.858 5.858a9 9 0 0112.728 0m-2.828 9.9a5 5 0 01-7.072 0" /></svg>
                <span id="generate-btn-text">생성하기</span>
                <div id="generate-loader" class="loader ease-linear rounded-full border-2 border-t-2 border-gray-200 h-5 w-5 mr-2 hidden"></div>
            </button>
        </footer>
    </main>

    <script>
        const PROXY_BASE_URL = "";
        let allVoices = [];
        let currentFilters = {
            language: '',
            gender: '',
            age: '',
            name: ''
        };
        let selectedVoiceId = null;
        let audioPlayer = null;

        const statusMessage = document.getElementById('status-message');
        const voiceGrid = document.getElementById('voice-grid');
        const emptyState = document.getElementById('empty-state');
        const loadingState = document.getElementById('loading-state');
        const textInput = document.getElementById('text-input');
        const generateBtn = document.getElementById('generate-btn');
        const generateBtnText = document.getElementById('generate-btn-text');
        const generateLoader = document.getElementById('generate-loader');
        const generateIcon = document.getElementById('generate-icon');

        async function getVoices() {
            const res = await fetch(`${PROXY_BASE_URL}/api/voices`);
            if (!res.ok) {
                const errorText = await res.text();
                throw new Error(errorText || `Server Error: ${res.status}`);
            }
            const data = await res.json();
            // The API response structure from Supertone is { data: [...] }. This reliably extracts the array.
            return data.data || [];
        }

        async function tts(text, voiceId) {
            const res = await fetch(`${PROXY_BASE_URL}/api/proxy/${voiceId}`, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ text, language: "ko", style: "neutral" })
            });
            if (!res.ok) throw new Error(await res.text());
            const blob = await res.blob();
            const url = URL.createObjectURL(blob);
            if (audioPlayer) audioPlayer.pause();
            audioPlayer = new Audio(url);
            audioPlayer.play();
        }

        function renderVoices() {
            voiceGrid.innerHTML = '';
            
            const filteredVoices = allVoices.filter(voice => {
                return (currentFilters.language ? voice.language.includes(currentFilters.language) : true) &&
                       (currentFilters.gender ? voice.gender === currentFilters.gender : true) &&
                       (currentFilters.age ? voice.age === currentFilters.age : true) &&
                       (currentFilters.name ? voice.name.toLowerCase().includes(currentFilters.name.toLowerCase()) : true);
            });

            statusMessage.textContent = `${filteredVoices.length}개의 목소리를 찾았습니다. (총 ${allVoices.length}개)`;

            if (filteredVoices.length === 0) {
                emptyState.classList.remove('hidden');
                voiceGrid.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                voiceGrid.classList.remove('hidden');
            }

            filteredVoices.forEach(voice => {
                const card = document.createElement('div');
                card.className = 'voice-card p-4 rounded-lg flex flex-col items-center text-center cursor-pointer';
                card.dataset.voiceId = voice.voice_id;

                card.innerHTML = `
                    <img src="${voice.thumbnail_image_url || 'https://placehold.co/80x80/e2e8f0/64748b?text=??'}" alt="${voice.name}" class="w-20 h-20 rounded-full mb-3 object-cover border-2 border-transparent">
                    <h3 class="font-bold text-md">${voice.name}</h3>
                    <p class="text-xs text-gray-500">${voice.gender}, ${voice.age}</p>
                    <button data-sample-url="${voice.samples?.[0]?.url}" class="mt-2 text-xs bg-gray-200 dark:bg-gray-600 px-2 py-1 rounded-full hover:bg-gray-300 dark:hover:bg-gray-500 transition disabled:opacity-50" ${!voice.samples?.[0]?.url ? 'disabled' : ''}>샘플 듣기</button>
                `;
                
                voiceGrid.appendChild(card);

                card.querySelector('button').addEventListener('click', (e) => {
                    e.stopPropagation();
                    const sampleUrl = e.target.dataset.sampleUrl;
                    if(sampleUrl) {
                        if (audioPlayer) audioPlayer.pause();
                        audioPlayer = new Audio(sampleUrl);
                        audioPlayer.play();
                    }
                });

                card.addEventListener('click', () => {
                    document.querySelectorAll('.voice-card').forEach(c => {
                        c.classList.remove('ring-2', 'ring-blue-500');
                        c.querySelector('img').classList.remove('border-blue-500');
                    });
                    card.classList.add('ring-2', 'ring-blue-500');
                    card.querySelector('img').classList.add('border-blue-500');
                    selectedVoiceId = voice.voice_id;
                    updateGenerateButtonState();
                });
            });
        }
        
        function updateGenerateButtonState() {
            generateBtn.disabled = !(selectedVoiceId && textInput.value.trim());
        }

        // Event Listeners
        document.querySelectorAll('.filter-group').forEach(group => {
            group.addEventListener('click', (e) => {
                if (e.target.classList.contains('filter-btn')) {
                    const key = group.dataset.filterKey;
                    const value = e.target.dataset.value;

                    currentFilters[key] = value;

                    group.querySelectorAll('.filter-btn').forEach(btn => {
                        btn.classList.remove('bg-blue-500', 'text-white');
                        btn.classList.remove('dark:bg-blue-500');
                    });
                    e.target.classList.add('bg-blue-500', 'text-white');
                    e.target.classList.add('dark:bg-blue-500');
                    
                    renderVoices();
                }
            });
        });

        document.getElementById('name-search').addEventListener('input', (e) => {
            currentFilters.name = e.target.value;
            renderVoices();
        });

        textInput.addEventListener('input', updateGenerateButtonState);

        generateBtn.addEventListener('click', async () => {
            if (generateBtn.disabled) return;
            generateLoader.classList.remove('hidden');
            generateIcon.classList.add('hidden');
            generateBtnText.textContent = "생성중...";
            generateBtn.disabled = true;
            try {
                await tts(textInput.value, selectedVoiceId);
            } catch (error) {
                alert(`음성 생성 실패: ${error.message}`);
            } finally {
                generateLoader.classList.add('hidden');
                generateIcon.classList.remove('hidden');
                generateBtnText.textContent = "생성하기";
                updateGenerateButtonState();
            }
        });
        
        // Initial Load
        window.addEventListener('load', async () => {
            statusMessage.textContent = '목소리 목록을 불러오는 중...';
            try {
                allVoices = await getVoices();
                loadingState.classList.add('hidden');
                renderVoices();
            } catch (error) {
                loadingState.classList.add('hidden');
                statusMessage.textContent = `오류: ${error.message}`;
                statusMessage.classList.add('text-red-600');
            }
        });
    </script>
</body>
</html>

